name: Daily Todo Automation

on:
  schedule:
    - cron: '0 8 * * *' # Tous les jours √† 8h00
  workflow_dispatch:      # Permet le lancement manuel

jobs:
  run-automation:
    runs-on: ubuntu-latest

    steps:
      # 1. On r√©cup√®re tout le code du d√©p√¥t
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. V√âRIFICATION (Debug) : On liste les fichiers pour √™tre s√ªr
      - name: üîç V√©rifier la pr√©sence du fichier
        run: |
          ls -la
          if [ -f "./workflow.json" ]; then
            echo "‚úÖ Le fichier workflow.json est bien l√† !"
          else
            echo "‚ùå ERREUR : Le fichier workflow.json est introuvable √† la racine."
            exit 1
          fi

      # 3. Installation de Node.js (pour n8n)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 4. Installation de Python (INDISPENSABLE car ton workflow utilise Python)
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      # 5. Cr√©ation de l'environnement virtuel Python pour n8n
      # Cela corrige l'erreur "Failed to start Python task runner"
      - name: Setup Python Virtual Env
        run: |
          python -m venv /home/runner/.n8n/python_env
          source /home/runner/.n8n/python_env/bin/activate
          # Installe des librairies classiques au cas o√π ton script en a besoin
          pip install requests pandas

      # 6. Installation de n8n
      - name: Install n8n
        run: npm install -g n8n

      # 7. Cr√©ation du fichier .env (S√©curit√©)
      - name: Create .env file
        run: |
          echo "GOOGLE_CALENDAR_OAUTH2_API_CREDENTIALS=${{ secrets.GOOGLE_CALENDAR_OAUTH2_API_CREDENTIALS }}" >> .env
          echo "GMAIL_OAUTH2_API_CREDENTIALS=${{ secrets.GMAIL_OAUTH2_API_CREDENTIALS }}" >> .env
          echo "OPENAI_API_CREDENTIALS=${{ secrets.OPENAI_API_CREDENTIALS }}" >> .env
          echo "N8N_ENCRYPTION_KEY=${{ secrets.N8N_ENCRYPTION_KEY }}" >> .env

      # 8. Ex√©cution du workflow
      - name: Execute n8n Workflow
        run: |
          # On dit √† n8n o√π trouver Python
          export N8N_PYTHON_INTERPRETER=/home/runner/.n8n/python_env/bin/python
          
          # On lance avec le chemin explicite "./"
          n8n execute --file=./workflow.json
        env:
          N8N_ENCRYPTION_KEY: ${{ secrets.N8N_ENCRYPTION_KEY }}