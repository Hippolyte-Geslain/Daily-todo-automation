name: Daily Todo Automation

on:
  schedule:
    - cron: '0 8 * * *' # Tous les jours √† 8h00
  workflow_dispatch:      # Permet le lancement manuel pour tester

jobs:
  run-automation:
    runs-on: ubuntu-latest

    steps:
      # 1. R√©cup√©ration du code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. DEBUG : V√©rification de la pr√©sence du fichier JSON
      - name: üìÇ Debug File Check
        run: |
          echo "Chemin actuel : $(pwd)"
          ls -la
          if [ -f "workflow.json" ]; then
            echo "‚úÖ Succ√®s : workflow.json est bien pr√©sent."
          else
            echo "‚ùå ERREUR : workflow.json est introuvable !"
            exit 1
          fi

      # 3. Installation de Node.js (Requis pour n8n)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 4. Installation de n8n
      - name: Install n8n
        run: npm install -g n8n

      # 5. Cr√©ation du fichier .env pour les identifiants
      - name: Create .env file
        run: |
          echo "GOOGLE_CALENDAR_OAUTH2_API_CREDENTIALS=${{ secrets.GOOGLE_CALENDAR_OAUTH2_API_CREDENTIALS }}" >> .env
          echo "GMAIL_OAUTH2_API_CREDENTIALS=${{ secrets.GMAIL_OAUTH2_API_CREDENTIALS }}" >> .env
          echo "OPENAI_API_CREDENTIALS=${{ secrets.OPENAI_API_CREDENTIALS }}" >> .env
          echo "N8N_ENCRYPTION_KEY=${{ secrets.N8N_ENCRYPTION_KEY }}" >> .env

      # 6. Ex√©cution du workflow
      - name: Execute n8n Workflow
        run: |
          # On lance n8n en pointant explicitement vers le fichier du dossier courant
          n8n execute --file "$(pwd)/workflow.json"
        env:
          # Ces variables sont critiques pour que n8n lise le .env
          N8N_ENCRYPTION_KEY: ${{ secrets.N8N_ENCRYPTION_KEY }}