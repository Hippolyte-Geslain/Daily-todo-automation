name: Daily Todo Automation

# Déclencheurs
on:
  schedule:
    # Cron : À 8h00 UTC tous les jours (vérifie ton fuseau horaire, UTC est souvent -1h ou -2h vs France)
    - cron: '0 8 * * *'
  # Permet de lancer manuellement depuis l'interface GitHub pour tester
  workflow_dispatch:

jobs:
  run-automation:
    runs-on: ubuntu-latest

    steps:
      # 1. Récupérer le code du dépôt
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Installer Node.js (Version 20 comme demandé)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 3. Installer n8n
      - name: Install n8n
        run: npm install -g n8n

      # 4. Créer le fichier .env à partir des Secrets GitHub
      # C'est l'étape CRITIQUE pour la sécurité. On injecte les secrets dans un fichier temporaire.
      - name: Create .env file
        run: |
          echo "GOOGLE_CALENDAR_OAUTH2_API_CREDENTIALS=${{ secrets.GOOGLE_CALENDAR_OAUTH2_API_CREDENTIALS }}" >> .env
          echo "GMAIL_OAUTH2_API_CREDENTIALS=${{ secrets.GMAIL_OAUTH2_API_CREDENTIALS }}" >> .env
          echo "OPENAI_API_CREDENTIALS=${{ secrets.OPENAI_API_CREDENTIALS }}" >> .env
          # On exporte aussi une clé de chiffrement pour n8n (recommandé)
          echo "N8N_ENCRYPTION_KEY=${{ secrets.N8N_ENCRYPTION_KEY }}" >> .env

      # 5. Exécuter le workflow
      # On pointe vers le fichier workflow.json présent dans le dépôt
      - name: Execute n8n Workflow
        run: n8n execute --file=workflow.json
        env:
          # On s'assure que n8n a accès aux variables d'environnement si besoin direct
          N8N_ENCRYPTION_KEY: ${{ secrets.N8N_ENCRYPTION_KEY }}